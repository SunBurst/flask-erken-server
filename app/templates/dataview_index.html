{% extends 'base.html' %}

{% block collapsiblesection %}
    
    <div class="collapsible-section-tabs" style="margin-top: 0px;">
        <div class="header-background full-site-width">
            <div class="doc-set-nav-row">
                <nav class="doc-set-nav nav overflow-tabs-scroll-wrapper">
                    <ul class="doc-set-nav-tab-list overflow-tabs-scroll" style="min-width: 681px; left: 0px;">
                        <li class="doc-set-nav-tab-container">
                            <a href="https://developers.google.com/maps/documentation/javascript/" class="doc-set-nav-tab gc-analytics-event" data-category="Site-Wide Custom Events" data-label="Tab: Overview">Overview</a>
                        </li>
                        <li class="doc-set-nav-tab-container">
                            <a href="https://developers.google.com/maps/documentation/javascript/tutorial" class="doc-set-nav-activedoc-set-nav-tab gc-analytics-event" data-category="Site-Wide Custom Events" data-label="Tab: Guides">Guides</a>
                        </li>
                        <li class="doc-set-nav-tab-container">
                            <a href="https://developers.google.com/maps/documentation/javascript/3.exp/reference" class="doc-set-nav-tab gc-analytics-event" data-category="Site-Wide Custom Events" data-label="Tab: Reference">Reference</a>
                        </li>
                        <li class="doc-set-nav-tab-container">
                            <a href="https://developers.google.com/maps/documentation/javascript/examples/" class="doc-set-nav-tab gc-analytics-event" data-category="Site-Wide Custom Events" data-label="Tab: Samples">Samples</a>
                        </li>
                        <li class="doc-set-nav-tab-container">
                            <a href="https://developers.google.com/maps/documentation/javascript/support" class="doc-set-nav-tab gc-analytics-event" data-category="Site-Wide Custom Events" data-label="Tab: Support">Support</a>
                        </li>
                        <button type="button" id="feedback-project" class="feedback-button top-button gc-analytics-event" data-category="Site-Wide Custom Events" data-label="Send Feedback Button" track-type="feedback" track-name="sendFeedbackLink" track-metadata-position="header">Send feedback</button>
                    </ul>
                    <button type="button" class="overflow-tabs-scroll-button top-button material-icons scroll-forward hidden"></button><button type="button" class="overflow-tabs-scroll-button top-button material-icons scroll-back hidden"></button>
                </nav>
            </div>
        </div>
    </div>

{% endblock %}


{% block content %}

    <!-- <div class="bt"> -->
        <!-- <div class="bw"> -->
          <!-- <h1>Erken Laboratory Monitoring</h1> -->
          <!-- <p>Research at the Erken Laboratory focuses on the long-term monitoring of water quality, climate effects on aquatic systems, circulation of nutrients, population and community dynamics in lakes.</p> -->
        <!-- </div> -->
    <!-- </div> -->
    <div class="col-lg-12">
        <div class="locations-map-container">
            <div id="locations-map-canvas" class="locations-map-canvas"></div>
        </div>
    </div>

{% endblock %}

{% block extrajs %}
    
    <script>
    $(document).ready(function() {
        var getLocationsUrl = '/locations/get_locations';
        var getParametersUrl = '/locations/get_locations_parameters';
        var map;
        var markerCluster;
        var markers = [];
        var markerListeners = [];
        //var bounds = new google.maps.LatLngBounds();
        var options = {imagePath: '{{ url_for('static', filename='js/googlemaps-markerer-cluster/images/m') }}'};
        
        var contentString = '<div id="content">'+
            '<div id="siteNotice">'+
            '</div>'+
            '<h3 id="firstHeading" class="firstHeading"></h3>'+
            '<div id="bodyContent">'+
            '<div id="chart-container"></div>' + 
            '</div>'+
            '</div>';
        
        var infowindow = new google.maps.InfoWindow({
          content: contentString
        });
        
        function initChart(stationId, paramId, parameterName, unit, data) {

            options = {

                chart: {
                    renderTo: 'chart-container',
                    zoomType: 'x'
                },
                title: {
                    text: 'Hourly Measurements',
                    x: -20 //center
                },
                subtitle: {
                    text: 'Subtitle',
                    x: -20
                },
                xAxis: {
                    title: {
                        text: null
                    },
                    type: 'datetime'
                },
                yAxis: {
                    title: {
                        text: parameterName + ' (' + unit + ')',
                    },
                    labels: {
                        formatter: function() {
                            return this.value;
                        }
                    },
                    plotLines: [{
                        value: 0,
                        width: 1,
                        color: '#808080'
                    }]
                },
                legend: {
                    title: {
                        text: 'Sensor<br/><span style="font-size: 9px; color: #666; font-weight: normal">(Click to hide)</span>',
                        style: {
                            fontStyle: 'italic'
                        }
                    },
                    layout: 'vertical',
                    align: 'right',
                    verticalAlign: 'middle',
                    borderWidth: 1
                },
                responsive: {
                    rules: [{
                        condition: {
                            maxWidth: 500
                        },
                    }]
                },
                series: data,
            }

            new Highcharts.Chart(options);
        }
        
        function initMap(data) {
            var mapOptions = {
                zoom: 6,
                center: new google.maps.LatLng(63, 16),
                mapTypeControl: true,
                streetViewControl: false,
                mapTypeControlOptions: {
                    mapTypeIds: ['roadmap', 'satellite', 'hybrid', 'terrain', 'styled_map'],
                    style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
                    position: google.maps.ControlPosition.TOP_CENTER
                },
                fullscreenControl: true
            };
            map = new google.maps.Map(document.getElementById('locations-map-canvas'), 
                mapOptions);
            
            var legend = document.createElement('div');
            legend.id = 'legend';
            var content = ['<div class="panel-body no-padding"><div id="map-parameters-menu" class="list-group">'];
            $.each(data, function (index, parameterData) {
                content.push('<a href="#" data=' + parameterData.parameter_id + ' class="list-group-item">' + parameterData.parameter_name + '</a>');
            });
            
            content.push('</div></div>');
            legend.innerHTML = content.join('');
            legend.index = 1;
            map.controls[google.maps.ControlPosition.LEFT_TOP].push(legend);
        }

        function loadAllLocations() {
            return $.getJSON(getLocationsUrl).done(function(data) {
                $.each(data, function (location, locationData) {
                    var locationId = locationData.id;
                    var locationName = locationData.name;
                    var locationDescription = locationData.description;
                    var locationImages = locationData.images;
                    var locationLat = locationData.position.latitude;
                    var locationLng = locationData.position.longitude;
                    var locationLatLng = new google.maps.LatLng(locationLat, locationLng);

                    addMarker(locationId, locationName, locationLatLng, locationDescription, locationImages);
                    //bounds.extend(locationLatLng);
                });
            });
        }
        
        function loadAllParameters() {
            return $.getJSON(getParametersUrl).done(function(data) {
                return data;
            });
        }
        
        function moveCenter(lat, lng){
            var center = new google.maps.LatLng(lat, lng);
            map.panTo(center);
        }
        
        function addParameterMarker(paramId) {
            var getParameterStationsUrl = '/locations/get_parameter_stations/' + paramId;
            var getStationHourlyMeasurementsParamBaseUrl = '/stations/get_station_hourly/';
            return $.getJSON(getParameterStationsUrl).done(function(data) {
                $.each(data, function (index, station) {
                    var timeout = index * 200;
                    var stationLat = station.station_position.latitude;
                    var stationLng = station.station_position.longitude;
                    var stationLatLng = new google.maps.LatLng(stationLat, stationLng);                    
                    var marker = new google.maps.Marker({
                        position: stationLatLng,
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            fillColor: 'red',
                            fillOpacity: .4,
                            scale: 5,
                            strokeColor: 'white',
                            strokeWeight: .5
                        },
                        map: map,
                        title: station.station_name,
                        animation: google.maps.Animation.DROP
                    });
                    window.setTimeout(function() {
                        markers.push(marker);
                        var markerListener = marker.addListener('click', function() {
                          infowindow.open(map, marker);
                          getStationHourlyMeasurementsParamUrl = getStationHourlyMeasurementsParamBaseUrl + station.station_id + '/' + paramId + '/' + 0 + '/2016/';
                          console.log(station);
                          $('#firstHeading').html('<i class="fa fa-globe fa-fw"></i> ' 
                              + station.location_name 
                              + ' / <i class="fa fa-map-marker fa-fw"></i> ' 
                              + station.station_name);
                          
                          $.getJSON(getStationHourlyMeasurementsParamUrl).done(function(result) {
                              var seriesData = [];
                              var foundSensors = {};
                              $.each(result, function(i, reading) {
                                  sensorId = reading.sensor_id;
                                  sensorName = reading.sensor_name;
                                  //sensorNameId = sensorName + ' (' + sensorId + ') ';
                                  if (sensorId in foundSensors) {}
                                  else {
                                      foundSensors[sensorId] = {'name': sensorName, 'data': []};
                                  }
                                  foundSensors[sensorId]['data'].push([reading.date_hour, reading.avg_value]);
                              });
                              
                              $.each(foundSensors, function(key, sensorData) {
                                  seriesData.push({'name': sensorData.name, 'data': sensorData.data});
                              });
                              
                              initChart(station.station_id, paramId, station.parameter_name, station.parameter_unit, seriesData);
                              
                          });
                            
                          //initChart();
                        markerListeners.push(markerListener);
                        //bounds.extend(locationLatLng);
                        });
                    }, timeout);
                });
            });
        }
        
        function addMarker(id, name, latlng, description, images) {
            var marker = new google.maps.Marker({
                position: latlng,
                map: map,
                title: name
            });

            var infoWindowContent =
                '<div id="info-window-' + id + '">' +
                    '<div id="info-window' + id + '-notice"></div>' +
                    '<a href="/sites/site?site_id=' + id + '">' +
                        '<h3 id="info-window-' + id + '-heading" class="infoContentHeading">' + name + '</h3>' +
                    '</a>' +
                    '<div id="info-window-' + id + '-bodyContent">' +
                        '<p>' + 'WGS84: ' + latlng.lat() + ', ' + latlng.lng() + '</p>' +
                        
                        //'<img class="img-responsive" src="/static/images/sites/' + image +
                        //    '" alt="' + name + '" height="300" width="300"></img>' +
                        '<p>' + description  + '</p>' +
                    '</div>' +
                '</div>';

            var infoWindow = new google.maps.InfoWindow({
                content: infoWindowContent
            });

            marker.addListener('click', function() {
                infoWindow.open(map, marker);
            });

            markers.push(marker);
        }
        
        loadAllParameters().done(function(result) {
            initMap(result);
        });
        //loadAllLocations().done(function() {
        //    var options = {imagePath: '{{ url_for('static', filename='js/googlemaps-markerer-cluster/images/m') }}'};
        //    var markerCluster = new MarkerClusterer(map, markers, options);
           
        //    if (bounds.isEmpty()) {}
        //    else {
        //        map.fitBounds(bounds);
        //    }
        //});
        //loadAllParameters();
        
        $('#locations-map-canvas').on('click', '.list-group a', function(event) {
            event.preventDefault();
            var paramId = $(this).attr('data');
            
            // Unset all markers
            var i = 0, l = markers.length;
            for (i; i<l; i++) {
                markers[i].setMap(null)
                google.maps.event.removeListener(markerListeners[i]);
            }
            markers = [];
            markerListeners = [];

            // Clears all clusters and markers from the clusterer.

            if (typeof markerCluster != 'undefined') {
                markerCluster.clearMarkers();   
            }

            addParameterMarker(paramId);
            markerCluster = new MarkerClusterer(map, markers, options);
            
            //if (bounds.isEmpty()) {}
            //else {
            //    map.fitBounds(bounds);
            //}
        });
        
    });
    
    </script>

{% endblock %}
